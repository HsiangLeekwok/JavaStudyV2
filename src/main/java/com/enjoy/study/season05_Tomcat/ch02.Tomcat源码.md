# Tomcat源码分析

## Tomcat 源码下载以及安装

### 1、源码下载地址：https://tomcat.apache.org/download-80.cgi

### 2、解压、新建 catalina-home 目录，同时将目录中的 conf 和 webapps 文件夹复制到 catalina-home 目录中

### 3、需要通过Maven组织文件，因此需要在根目录下创建目录中新建pom.xml文件
    
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
 
    <modelVersion>4.0.0</modelVersion>
    <groupId>org.apache.tomcat</groupId>
    <artifactId>Tomcat8.5</artifactId>
    <name>Tomcat8.5</name>
    <version>8.5</version>
 
    <build>
        <finalName>Tomcat8.5</finalName>
        <sourceDirectory>java</sourceDirectory>
        <testSourceDirectory>test</testSourceDirectory>
        <resources>
            <resource>
                <directory>java</directory>
            </resource>
        </resources>
        <testResources>
           <testResource>
                <directory>test</directory>
           </testResource>
        </testResources>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>2.3</version>
                <configuration>
                    <encoding>UTF-8</encoding>
                    <source>1.8</source>
                    <target>1.8</target>
                </configuration>
            </plugin>
        </plugins>
    </build>
 
    <dependencies>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.12</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.easymock</groupId>
            <artifactId>easymock</artifactId>
            <version>3.4</version>
        </dependency>
        <dependency>
            <groupId>ant</groupId>
            <artifactId>ant</artifactId>
            <version>1.7.0</version>
        </dependency>
        <dependency>
            <groupId>wsdl4j</groupId>
            <artifactId>wsdl4j</artifactId>
            <version>1.6.2</version>
        </dependency>
        <dependency>
            <groupId>javax.xml</groupId>
            <artifactId>jaxrpc</artifactId>
            <version>1.1</version>
        </dependency>
        <dependency>
            <groupId>org.eclipse.jdt.core.compiler</groupId>
            <artifactId>ecj</artifactId>
            <version>4.5.1</version>
        </dependency>
       
    </dependencies>
</project>
```
    
### 4、配置IDEA运行项目

- 通过pom.xml文件构建一个新的工程
- 如果编译build的时候出现Test测试代码报错，注释该代码即可。Tomcat源码util.TestCookieFilter类会报错，将其注释即可
- Tomcat启动的目录为一个main方法类：org.apache.catalina.startup.Bootstrap
- 添加VM options(如下)
- 运行项目，访问http://localhost:8080，得到结果可能是无法解析 JSP，需要添加 JSP 的解析器
- 修改完后，项目再启动，在浏览器访问 http://localhost:8080/，就可以看到我们所熟悉的经典欢迎页面了

```text
# jsp 解析器
-Dcatalina.home=catalina-home
-Dcatalina.base=catalina-home
-Djava.endorsed.dirs=catalina-home/endorsed
-Djava.io.tmpdir=catalina-home/temp
-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager
-Djava.util.logging.config.file=catalina-home/conf/logging.properties
```

```java
// 添加 jsp 解析器
// 在 tomcat 的源码 org.apache.catalina.startup.ContextConfig 中的 configureStart 函数中手动将 JSP 解析器初始化：
// 添加代码(添加到 webConfig(); 这一句之后即可)

/**
 * Startup event listener for a <b>Context</b> that configures the properties
 * of that Context, and the associated defined servlets.
 *
 * @author Craig R. McClanahan
 */
public class ContextConfig implements LifecycleListener {
    /**
     * Process a "contextConfig" event for this Context.
     */
    protected synchronized void configureStart() {
        //..........
    
        webConfig(); 
    
        // 添加 jsp 解析器
        context.addServletContainerInitializer(new JasperInitializer(), null);
        // .........
    }
}
```

## Tomcat 启动流程分析

![Tomcate启动流程示意图](TIM20190723122422.png)

### 组件的生命周期管理

各组件用 Lifecycle 管理启动、停止、关闭操作

- Lifecycle 接口预览
- 几个核心方法
- Server 中的 init 方法示例
- 为啥 StandardServer 没有 init 方法
- LifecycleBase 中的 init 与 initInternal 方法
- 为什么这么设计？

### 分析 tomcat 请求过程

连接器 connector 与容器 container

- 为了解耦

connector 设计

- 监听服务端口，读取来自客户端的请求
- 将请求数据按照指定协议进行解析
- 根据请求地址匹配正确的容器进行处理
- 将相应返回给客户端

container 设计

- Servlet容器的实现

Servlet的请求和相应如何在容器中流转呢？

![Tomcate启动流程示意图](TIM20190723130356.png)

### 管道模式

管道与阀门

    管道就像一条管道把多个对象连接起来，整体看起来就像若干个阀门潜逃在管道中，而处理逻辑放在阀门上

    手写一个管道模式实现
    
![Tomcate启动流程示意图](TIM20190723165942.png)

- StandardEngine 容器初始化的东西(server.xml)
- StandardEngineValve 一个请求过来，这里封装需要处理的东西

    Tomcat 里自定义了一些比较重要的阀门类
