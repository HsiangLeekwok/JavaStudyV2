# 网络协议

## 书籍推荐

- Java网络编程
- Netty权威指南
- Netty实战
- Unix网络编程

## 计算机网络体系结构

- 各层关系，每一个抽象层建立在低一层提供的服务商，并且为高一层提供服务
- 程序员充电关注 TCP/IP 模型
- OSI 七层模型了解即可

### TCP/IP 模型和 OSI 模型

    TCP/IP     OSI
    应用层     应用层     为应用程序提供服务
              表示层     数据格式转换、数据加密等
              会话层     建立、管理和维护回话
    传输层     传输层     简历、管理和维护端对端的连接
    网络层     网络层     IP选址及路由选择
    链路层     链路层     提供介质访问和链路管理，如网卡和网卡的驱动程序
              物理层     物理传输

### TCP/IP 协议族

    Transmission Control Protocol/Internet Protocol的简写。中文译名为传输控制协议/因特网互联协议，是 Internet 最基本的协议、Internet 国际互联网络的基础，由网络层的 IP 协议和传输层的 TCP 协议组成。
    协议采用了 4 层结构。然而在很多情况下，它是利用 IP 进行通信时所必须用到的协议群的统称。
    
|TCP/IP概念层模型|功能|TCP/IP协议族|
|:---:|:---:|:---:|
|应用层|文件传输，电子邮件，文件防伪，虚拟终端|TFTP、HTTP、SNMP、FTP、SMTP、DNS、Telnet|
|-|数据格式化，代码转换，数据加密|没有协议|
|-|解除或建立与别的节点的联系|没有协议|
|传输层|提供端对端的接口|TCP、UDP|
|网络层|为数据包选择路由|IP、ICMP、RIP、OSPF、BCP、ICMP|
|链路层|传输有地址的帧以及错误检测功能|SLIP、CSLIP、PPP、ARP、RARP、MTU|
|-|已二进制数据形式在物理媒体桑传输数据|ISO2110、IEEE802、IEEE802.2|

    TCP ：面向连接的、可靠的流协议
    UDP ：面向无连接的通讯协议
    IP  ：在源地址和目的地址之间传送的数据包
    ICMP：控制报文协议
    IGMP：Internet组管理协议
    ARP ：地址解析协议
    RARP：反响地址转化协议
    
### 网络通讯中的地址和端口号

    MAC 地址和 IP 地址、端口号
        端口号用来识别同一台计算机中进行通信的不同应用程序，因此它也被称为程序地址
        MAC 地址：物理地址、硬件地址、绝对地址，一般无法修改，和网络无关，如路由器地址、网卡地址
        IP 地址：标记网络上某一台机器的地址，逻辑地址，可以随意修改
        
### TCP 中的三次握手  面试点

    三次握手：建立一个TCP连接时，需要客户端和服务端共发送3个包以确认连接的建立。
    
    为什么需要3次握手？TCP是面对的连接的，所以需要双方都确认连接的建立。
    - 第一次握手，客户端请求建立连接 
        SYN_SENT，发送SYN=1，seq=k
    - 第二次握手，服务端应答客户端，并请求建立连接
        SYN_RCVD，发送SYN=1，ACK=1，ack=k+1，seq=j(针对客户的那的SYN确认应答)
    - 第三次握手，客户端针对服务端请求确认应答
        ESTABLISHED，发送ACK=1，ack=j+1(确认服务端发送的SYN，服务端收到后也会变成 ESTABLISHED)
        
#### TCP的3次握手的漏洞

SYN洪泛攻击

    定义：通过网络服务所在的端口发送大量伪造源地址的攻击报文，发送到服务端，造成服务端上的半开连接队列被占满，从而阻止其他用户进行访问。
    原理：攻击者客户端利用伪造的IP地址想服务端发出请求(第一次握手)，而服务端的相应（第二次握手）的报文将永远发送不到真实的客户端，服务端在等待客户端的第三次握手（永远不会有），服务端在等待这种半开连接的过程中消耗了资源，如果有成千上万的这种连接，主机资源将被耗尽，从而达到攻击的目的。
    解决：
        - 无效链接监控释放
        - 延缓 TCB 分配方法
        - 防火墙
		
### TCP中的四次挥手（可能的面试点）

	断开一个TCP连接时，需要客户但和服务端共发送4个包以确认连接的断开
	为什么需要四次挥手？TCP是双全工（即客户端和服务端可以互相发送和接收请求），所以需要双方都确认关闭连接
	过程：
		第一次：客户端发送关闭请求
		第二次：服务端相应客户端的关闭请求
		第三次：服务端发送关闭请求
		第四次：客户端发送关闭确认请求
		
### TCP/IP 中的数据包

- 包是全能性术语
- 帧用于表示数据链路层中包的单位
- 片是 IP 中数据的单位
- 段表示 TCP 数据里中的信息
- 消息指应用协议中数据的单位

### TCP的通讯原理

- socket套接字，TCP用主机的IP地址加上主机上的端口号作为TCP连接的端点，这种端点就叫做套接字socket
- TCP缓冲区，每个TCP的socket内核中都有一个发送缓冲区和一个接收缓冲区
- TCP的可靠性与高效率，有了缓冲区之后我们怎么传输才能确保高效与可靠？

    <-- read()/recv()   <--  data(输入缓冲区)  <--  data(输出缓冲区)  <--  write()/send()  <--
端A                                                                                             端B
    --> write()/send()  -->  data(输出缓冲区)  -->  data(输入缓冲区)  --> read()/recv()    --> 
	
### TCP协议中的窗口机制

- 滑动窗口
	- 发送方和接收方都会维护一个数据帧的序列，这个序列被称作窗口
	- 发送方的窗口大小由接收方确认
- 目的
	- 确保数据不丢失，如果发送的数据丢失了可以重新发
	- 控制发送的速度，以免接收方的缓存不够大导致溢出，同时控制流量也可以避免网络拥塞
	
### HTTP协议

	HTTP协议是 Hyper Text Transfer Protocol(超文本传输协议)的缩写，是用于从万维网(WWW: World Wide WSeb)服务器传输超文本到本地浏览器的传送协议
	
	- web客户端和服务器
	- 资源：html/文本、word、avi电影、其他资源
	- 媒体类型：Content-Type: text/html、image/jpeg
	- URI和URL：web服务器资源的名字和用于描述一个网络上资源的地址
	URI: 统一资源标识符
	URL：统一资源定位符，一种特殊类型的RUI，标识了资源在哪个位置
		- schema：http/https/ftp
		- host: web服务器的 ip 地址或域名
		- port：服务端端口，http默认访问的端口是80
		- path：资源访问路径
		- query-string：查询参数
	- 方法：GET/PUT/DELETE/POST/HEAD
	
#### 一次完整的http请求过程（面试点）

- 首先进行DNS域名解析（本地浏览器缓存、操作系统缓存或者DNS服务器）
- 1、三次握手建立TCP连接
- 2、客户端想服务器发送请求命令 GET/www.xx.com/ http/1.1
- 3、客户端发送请求头信息
- 4、服务器应答 http/1.1 200 OK
- 5、返回相应头信息
- 6、服务器向客户端发送数据
- 7、服务器关闭TCP连接

### HTTP报文结构

- 报文首部，服务器或客户端需要处理的请求或相应的内容及属性
- CR+LF，CR(Carriage Return回车符)，16进制0x0d和LF(Line Feed换行符)，16进制0x0a
- 报文主题

```text
// 一个请求报文内容
POST /from/entry HTTP/1.1
HOST: sample.com
Connection: keep-alive
Content-Type: application/x-www-form-urlencoded
Content-Length: 32

username=Deeson&password=123456

// 一个响应报文内容
HTTP/1.1 200 OK
Date: Mon, 10 Jul 2017 15:50:06 GMT
Content-Length: 256
Content-Type: text/html、image/jpeg

<html>
......
</html>
```

HTTP响应状态码

|代码|类别|原因|
|:---:|:---:|:---:|
|1xx|Informational(信息性状态码)|接收的请求正在处理|
|2xx|Success(成功状态码)|请求正常处理完毕|
|3xx|Redirection(重定向状态码)|需要进行附加操作以完成请求|
|4xx|Client Error(客户端错误状态码)|服务器无法处理请求|
|5xx|Server Error(服务器错误状态码)|服务器处理请求出错|

### UDP协议

- 面向无连接的通讯协议
- 通讯时不需要接收方确认，属于不可靠的传输
- 因为不需要建立连接，所以传输速度快，但是容易丢失数据

报文组成

- 源端口：源端口号，在需要对方回信时选用，不需要时可用全0
- 目的端口：在中断交付报文时必须要使用到
- 长度：UDP用户数据的长度，其最小值是8(仅有首部)
- 校验和：检测UDP用户数据报在传输中是否有错，有错就丢弃