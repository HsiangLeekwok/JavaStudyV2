# JVM调优和深入了解性能优化

## GC 调优原则

### 常用的性能评价、测试指标

    - 并发数：指同一时刻，对服务器又实际交互的请求书，和网站在线用户数的关联1000个
    - 吞吐量(TPS)：对单位时间内完成的工作量(请求)的量度。
        如：每分钟的数据库事务，每秒传送的文件千字节数
    - 关系：系统吞吐量和系统并发数以及响应时间的关系
        开车走高速：
            吞吐量：每天通过的车子数量（一天1w台车）
            响应时间：车速，一般情况下车速越快，吞吐量就高
            并发数：车流量。节假日并发数很高，如果超过一个阈值，堵车就很厉害

### 调优原则

    - 大多数的 java 应用不需要 GC 调优
    - 大部分需要 GC 调优的，不是参数问题，而是代码问题
    - 在实际项目中，分析 GC 情况优化代码比调整 GC 参数更重要
    - GC 调优是最后的手段
    
### GC 调优的目的

    - GC 的时间足够小
        参考性指标：
            - Minor GC 执行时间不到 50ms
            - Full GC 执行时间不到1s
    - GC 的次数足够小
        参考性指标
            - Minor GC 执行不频繁，大于 10s 一次
            - Full GC执行频率不算频繁，大于 10 分钟 1 次
            
### 调优步骤

    1、监视 GC 的状况
    2、分析结果，判断是否需要优化
    3、调整垃圾回收器的类型，内存分配
    4、不断分析和调整的过程
    5、全面应用参数
    
### 阅读 GC 日志

    主要关注 MinorGC 和 FullGC 的回收效率(回收前大小和回收比较)、回收的时间
    
### GC调优实战

    

### 项目启动 GC 优化

    1、开启日志分析 -XX:+PrintGCDetails
    2、调整Metadata控件 -XX:MetaspaceSize=64m
    3、减少 MinorGC 次数，调整堆的大小 -Xms1000m
    4、增加新生代比重，增加参数 -Xmn900m // 新生代空间大小：新生代900m，老年代100m
    5、加大新生代，调整参数 -Xms2000m -Xmn1800m
    
### 运行时 GC 优化，使用 jMeter

    使用 jMeter 同时访问三个接口 index，time，nobleMetal
    
    - 使用单线程GC： -XX:+UseSerialGC
    - 使用多线程GC： -XX:+UseParNewGC
    - 使用CMS： -XX:+UseConcMarkSweepGC
    - 使用G1： -XX:+UseG1GC
    
### 推荐策略

    1、堆控件设置：新生代的大小，满足吞吐量，需要满足新生代与老年代的比例，这种情况下大多数GC都发生在新生代
    2、老年代的大小选择：并发GC，使用并发垃圾回收器Par、CMS、G1
        GC调整很复杂，很细致。需要根据实际的情况
        
## 虚拟机的优化技术————逃逸分析

    逃逸分析：是目前JVM中比较前沿的优化技术，他不是直接的优化手段，而是为其他优化手段提供依据的分析技术
        逃逸分析的基本行为就是分析对象动态作用域
        逃逸分析是JVM的优化手段
        
    栈上分配：对象有可能在栈上进行分配(非常小的可能，不逃逸时)
    
    牵涉到的JVM参数
    -XX:-DoEscapeAnalysis // 取消逃逸分析，默认是开启的，此时新对象会分配在堆中
    -XX:+EliminateAllocations // 标量替换，默认开启
    -XX:+UseTLAB // 本地线程分配缓冲，默认打开
    
## 常用的优化手段

    避免过早优化(Donald Knuth)
    进行系统性能测试
    寻找系统瓶颈、分而治之、逐步优化
    
    1、前端优化
        浏览器、App：
            减少请求数(合并请求，合并css，js，图片，生产环境提高all.js)、http的keep-alive参数，默认是开启的
            使用客户端缓冲：浏览器缓存css/js/图片等，有关的属性：cache-control(相对时间)和expires(绝对时间)
            启用压缩：gzip，压缩率80%以上，但是启用压缩后客户端和服务端都加重了负担，减少了网络传输量，需要权衡一下
            资源文件的加载顺序：css在上，js在下，用户体验好
            减少cookie的传输：css、图片、无谓的数据，静态的数据不要放入cookie里；友好的提示
            
        CDN加速：内容分发网络，本质上是一个缓存，将数据缓存到最近的地方
        反响代理缓存：Nginx 动静分离，静态的文件缓存在反响代理服务器
        web组件分离
    2、应用服务性能优化
        - 缓存
            网站性能优化第一定律：优先考虑使用缓存优化性能
            缓存优化原则：缓存离用户越近越好
                - 缓存的基本原理和本质：读多写少(>2:1，一般10:1)，将数据的访问放到高效的介质中
                - 合理使用缓冲的准则：读写比高，数据一定是热点数据。缓存可用性、主备
                - 分布式缓存与一致性哈希
        - 集群
        - 异步：异步和同步，阻塞和非阻塞
            常见的异步手段：
                - Servlet异步
                - 多线程
                - 消息队列
        - 程序优化
            代码级别
            
    3、存储性能优化