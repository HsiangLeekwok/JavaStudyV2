# JVM 性能优化

## 内存溢出及案例分析

### 内存溢出的原因
    
    程序在申请内存时，没有足够的内存空间
    
### 内存溢出的几种方式

    - 栈溢出
    - 堆溢出
    - 方法区溢出(垃圾回收效率很低)
        动态语言、CGLib、JSP(第一次运行时需要编译成class)、OSGI
    - 本机内存直接溢出

## 内存泄漏及案例分析

### 内存泄漏的原因

    程序在申请内存后，无法释放已申请的内存空间
    
### 内存泄漏的几种原因

    - 长生命周期的对象持有短生命周期对象的引用
    - 连接未关闭
        数据库连接、网络连接、IO = try{} finally{}
    - 变量作用域不合理：变量定义出来，范围大雨了使用范围，没有及时置为 null
    - 内部类持有外部类：内部类一般定义为静态，如果不是静态，用引用(软引用、弱引用)来避免泄漏
        GC尝试回收掉外部类的实例，但内部类持有外部类的引用，导致GC不能正常回收
    - Hash值改变
    
### 内存溢出、内存泄漏的相同和不同

    相同：都会抛出异常，影响结果

    不同
        内存溢出：实实在在的内存不够了导致的
        内存泄漏：应该是放的对象美哟释放，导致可使用的内存缩小
    避免
        内存溢出：检查代码(是否有死循环等) + 设置一下虚拟机的参数
        内存泄漏：一定是代码有问题
        
        往往很多情况下内存溢出是内存泄漏导致的。

## 玩转 JDK 提供的工具

命令行工具

|名称|作用|
|-------|------------------------------------|
|jps|虚拟机进程状况查看当前运行的所有java进程|
|jstat|虚拟机统计信息监视工具|
|jinfo|Java配置信息工具|
|jmap|Java内存映像工具(堆转快照)|
|jhat|虚拟机堆转储快照|
|jstack|Java堆栈跟踪工具|

可视化工具

|名称|作用|
|-------|------------------------------------|
|JConsole|Java监视于管理控制台|
|JVisualVM| |


    jinfo -flag +PrintGCDetails <pid>
    java -XX:+PrintFlagsFinal -version
    jmap -dump:live,format=b,file=heap.bin <pid>
    jhat file// 不推荐
    jstack <pid>

## 了解 MAT

### 浅堆(Shallow Heap)和深堆(Retained Heap)

    浅堆(Shallow Heap)：分配一个对象所消耗的内存
    深堆(Retained Heap)：分配一个对象，(GC垃圾回收时)真实可回收的内存大小

### 它引用了谁？谁引用了它？

    incoming：引用了谁
    outgoing：谁引用了它

## GC 调优案例与实战