## 什么是限流

### 限流
    
    系统的访问量一旦达到阈值，就采用一些措施进行限制
    比如：延迟处理、拒绝处理、部分拒绝处理
    举例：北京市实施工作日高峰时段区域限行交通管理措施
    
## 限流深度剖析

### 限流的层面

- 接入层限流
- 应用层限流

### 限流算法

#### 计数器算法
    
    计数器算法是限流算法里最简单也是最容易实现的一种算法
    
    算法的缺点：
    临界问题（时间窗口不同，但超过了限制的访问量）
    
#### 令牌桶算法

    场景：
    系统每秒向桶内放入5个令牌
    桶的容量是5，如果桶已经满了，那么令牌被丢弃
    系统处理请求时，需先从令牌桶中拿到1个令牌，然后进行处理
    如果令牌桶中没有令牌，则该请求就被限制（流量干预）
    
    特点：
    没有临界问题
    缓冲区
    允许突发
    
##### 应用级限流实战——令牌桶算法限流

    限流的层面
        应用层限流（接口Controller）
    开源框架
        Guava框架中的RateLimiter类
        RateLimiter.tryAcquire()
        RateLimiter.tryAcquire(n)
        
    演示算法的特点：
        缓冲区
            第一秒可以处理的个数为限量数的2倍
            后续的请求会趋于额定数量
        允许突发
            请求处理时可以一次拿一个令牌
            也可以一次拿多个令牌（改变限流速率）
            
#### 分布式下的应用限流难点

    分布式限流的难点：
        应用部署有多台，需要进行全局限流
        负载均衡不一定能够“雨露均沾”
        
    关键解决方案：
        一个全局的“计数器”或“桶”
        把限流处理做成原子化
        
#### 分布式场景下的限流技术方案

全局计数器——Redis

- 基于键值对(key-value)的内存数据库
- 提供键过期机制(限制时间)

操作原子性

- 提供限流服务的原子性

实现方案

    Redis 结合 Lua 实现分布式场景下的限流
        分布式场景
        应用级别(接口)
        限流算法(计数器): 限制1分钟访问10次
        
限流技术如何运用到我们的工作

- 京东的部分业务就是使用 Redis + Lua 实现限流
- 优雅的实现可以使用 AOP + 自定义注解

高并发场景下技术仅仅是限流吗？

    百万级系统架构成长之路
        单机架构：
            特征：一个war包打天下
            技术策略：并发500个，加配置，并发编程，IO(NIO netty)，Tomcat调优，JVM优化
        集群结构：
            一个war包复制多分到多个服务器上
            特征：硬件及其的横向复制，对整个项目结构无影响
            技术策略：加负载nginx，msql读写分离
            大约能达到万级别的并发
        分布式 + 微服务：
            特征：细分业务为微服务，每一个微服务是一个完整的服务(从http请求道返回)，在微服务内部，将需要对外提供的接口，包装成rpc接口，对外开放
            技术策略：缓存、MQ，SpringCloud(微服务的架构), ES, 分库分表